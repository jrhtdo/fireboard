<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fire Compliance Dashboard</title>

  <!-- TailwindCSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>

  <!-- Spinner & Active Button Styles -->
  <style>
    .filter-btn.active {
      background-color: #2563eb; /* bg-blue-600 */
      color: #ffffff;            /* text-white */
      border: 2px solid #1e40af; /* darker border for active */
    }
    .filter-btn {
      border: 2px solid transparent;
    }
    .filter-btn:focus {
      outline: none;
      border-color: #1e40af;
    }
    #loadingSpinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }
  </style>

  <!-- List definitions JSON -->
  <script type="application/json" id="listDefinitions">
  {
    "All": [
      "Region",
      "Address",
      "Unit No",
      "Perceived sites",
      "Scheduled Date",
      "Plan Finish Date",
      "Scheduled Time",
      "Sequence",
      "Equipment_No",
      "Audit WorkOrder",
      "Repair WorkOrder",
      "Work Description",
      "Status",
      "Assigned Person",
      "Safety Alert",
      "Post Code",
      "Note",
      "Month",
      "Assignee"
    ],
    "List 1": ["Region"],
    "List 2": ["Perceived sites", "Equipment_No", "Audit WorkOrder", "Repair WorkOrder"],
    "List 3": ["Unit No", "Address", "Post Code", "Sequence", "Scheduled Time"],
    "List 4": ["Status"],
    "List 5": ["Safety Alert"],
    "List 6": ["Scheduled Date", "Plan Finish Date", "Month"]
  }
  </script>

  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css" rel="stylesheet"/>

  <!-- jsPDF + AutoTable for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>

<body class="bg-gray-100 text-gray-800">

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="flex items-center justify-center">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
  </div>

  <!-- Header -->
  <header class="bg-white shadow p-4 text-xl font-semibold flex justify-between items-center">
    <div>🔥 Fire Compliance Ltd. - Audit Dashboard [2025]</div>
    <a href="/pending_tasks"
       class="relative bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition text-sm">
      🕒 Tasks Due Soon
      <span id="dueCount"
            class="absolute -top-2 -right-2 bg-white text-red-600 font-bold rounded-full w-6 h-6 flex items-center justify-center text-xs shadow">
        0
      </span>
    </a>
  </header>

  <!-- Upload Section -->
  <section class="p-4 flex flex-col gap-4 items-center bg-white shadow mt-4 mx-4 rounded">
    <h2 class="text-lg font-semibold">📤 Upload CSV/Excel File</h2>
    <div class="flex gap-4 items-center">
      <a href="/csv-template" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 transition">
        📄 View CSV Format
      </a>
      <input id="fileInput" type="file" accept=".csv,.xlsx" class="border p-2 rounded w-72"/>
      <a href="/manual-entry" class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800 transition">
        📋 Manual Entry
      </a>
    </div>
    <button type="button" onclick="uploadFile()"
            class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
      🚀 Upload File
    </button>
    <div id="uploadStatus" class="text-sm mt-2"></div>
  </section>

  <!-- Filters & Table Controls -->
  <section class="mt-6 mx-4 bg-white p-4 rounded shadow">
    <!-- List Buttons -->
    <div id="listFilterButtons" role="tablist" class="flex flex-wrap gap-2 mb-4"></div>

    <!-- Column Select & Global Search -->
    <div class="flex flex-wrap justify-between mb-2">
      <label for="columnSelect" class="mr-2">🔽 Columns:</label>
      <select id="columnSelect" multiple class="border rounded px-2 py-1"></select>
      <input id="globalSearch" type="text" placeholder="🔍 Search..." class="border px-2 py-1 rounded"/>
    </div>

    <!-- Row Count -->
    <div class="mb-2 text-sm text-gray-600 flex items-center">
      <span id="rowCountDisplay">Total Rows: 0 | Filtered Rows: 0</span>
      <button id="refreshCountBtn"
              class="ml-4 px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">
        🔄 Refresh Count
      </button>
    </div>


    <!-- Data Table -->
    <div id="dynamicTable" class="w-full overflow-auto"></div>

    <!-- Export Buttons -->
    <div class="mt-4">
      <button id="exportCsvButton"
              class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition"
              aria-label="Export data to CSV">
        📥 Export CSV
      </button>
      <button id="exportPdfButton"
              class="ml-2 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition"
              aria-label="Export data to PDF">
        📄 Export PDF
      </button>
      
     
    </div>
    
  </section>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    // DOM refs & state
    const spinner       = document.getElementById("loadingSpinner");
    const statusDiv     = document.getElementById("uploadStatus");
    const countSpan     = document.getElementById("dueCount");
    const listDefs      = JSON.parse(document.getElementById("listDefinitions").textContent);
    const listContainer = document.getElementById("listFilterButtons");
    const colSelect     = document.getElementById("columnSelect");
    const globalSearch  = document.getElementById("globalSearch");
    const exportCsvBtn  = document.getElementById("exportCsvButton");
    const exportPdfBtn  = document.getElementById("exportPdfButton");
    let allColumns = [];
    let table;
    
    // Spinner helpers
    const showSpinner = () => spinner.style.display = "flex";
    const hideSpinner = () => spinner.style.display = "none";

    // Load JSON data from backend
    async function loadData(){
      showSpinner();
      try {
        const resp = await fetch("/api/data");
        if (!resp.ok) throw new Error("Failed to fetch data");
        return await resp.json();
      } catch (e) {
        console.error(e);
        statusDiv.textContent = "❌ Failed to load data.";
        statusDiv.className = "text-red-500";
        return [];
      } finally {
        hideSpinner();
      }
    }

    // Extract unique column names
    function getUniqueColumns(data){
      const keys = new Set();
      data.forEach(r => Object.keys(r).forEach(k => keys.add(k)));
      return Array.from(keys);
    }

    // Update total/filtered row counts
    function updateRowCount(){
      const total    = table.getDataCount("all");
      const filtered = table.getDataCount("active");
      document.getElementById("rowCountDisplay")
              .textContent = `Total Rows: ${total} | Filtered Rows: ${filtered}`;
    }

    // Build List-filter buttons
    function buildListButtons(){
      listContainer.innerHTML = "";
      listDefs["All"] = allColumns; // ensure “All” maps to every column
      Object.keys(listDefs).forEach(listName => {
        const btn = document.createElement("button");
        btn.type        = "button";
        btn.textContent = listName === "All" ? "All Columns" : listName;
        btn.className   = "filter-btn bg-gray-300 text-gray-800 px-3 py-1 rounded hover:bg-gray-400";
        btn.dataset.list = listName;
        btn.setAttribute("role", "tab");
        btn.setAttribute("aria-pressed", "false");
        btn.addEventListener("click", () => applyListFilter(listName, btn));
        listContainer.append(btn);
      });
    }

    // Initialize column multi-select
    function initColumnSelect(){
      colSelect.innerHTML = "";
      allColumns.forEach((col,i) => {
        const opt = document.createElement("option");
        opt.value       = col;
        opt.textContent = col;
        if (i < 6) opt.selected = true;
        colSelect.append(opt);
      });
      colSelect.addEventListener("change", () => {
        const chosen = Array.from(colSelect.selectedOptions).map(o => o.value);
        showHideColumns(chosen);
      });
    }

    // Show/hide columns helper
    function showHideColumns(colsToShow){
      allColumns.forEach(col => {
        if (colsToShow.includes(col)) table.showColumn(col);
        else                          table.hideColumn(col);
      });
      updateRowCount();
    }

    // Build the Tabulator column definitions
    function makeColumnsDef(){
      return [
        {
          title: "✏️ Edit", field: "edit",
          formatter: ()=>"<button class='bg-blue-500 text-white px-2 py-1 rounded text-sm'>Edit</button>",
          width: 90, hozAlign: "center",
          cellClick: (_e,cell)=> window.location.href = `/edit/${cell.getRow().getPosition()}`
        },
        ...allColumns.map(field => ({
          title: field,
          field: field,
          headerFilter: "input",
          headerFilterFunc: "=",
          headerFilterFuncParams: { ignoreCase: true },
          headerFilterLiveFilter: false,
          sorter: "string"
        }))
      ];
    }

    // One-time Tabulator init
    function initTabulator(data){
      table = new Tabulator("#dynamicTable", {
        data: data,
        layout: "fitColumns",
        pagination: "local",
        paginationSize: 10,
        columns: makeColumnsDef(),
        dataFiltered: updateRowCount,
        dataSorted:   updateRowCount
      });
      updateRowCount();
    }

    // Handle List-filter button clicks
    function applyListFilter(listName, btn){
      document.querySelectorAll(".filter-btn").forEach(b => {
        b.classList.remove("active");
        b.setAttribute("aria-pressed", "false");
      });
      btn.classList.add("active");
      btn.setAttribute("aria-pressed", "true");

      const cols = listDefs[listName] || [];
      showHideColumns(listName === "All" ? allColumns : cols);
      // sync the multi-select
      document.querySelectorAll("#columnSelect option").forEach(opt => {
        opt.selected = (listName === "All") ? true : cols.includes(opt.value);
      });
      localStorage.setItem("selectedList", listName);
    }

    // Global “contains” search & row count update
    globalSearch.addEventListener("input", e => {
      const term = e.target.value.toLowerCase();
      table.setFilter(row => 
        Object.values(row).some(v => String(v).toLowerCase().includes(term))
      );
      updateRowCount();
    });

    // CSV export & row count update
    exportCsvBtn.addEventListener("click", () => {
      try {
        showSpinner();
        setTimeout(() => {
          table.download("csv", "export.csv");
          updateRowCount();
          hideSpinner();
        }, 100);
      } catch (e) {
        console.error("CSV Export Failed:", e);
        statusDiv.textContent = "❌ CSV Export Failed.";
        statusDiv.className = "text-red-500";
        hideSpinner();
      }
    });

    // PDF export & row count update
    exportPdfBtn.addEventListener("click", () => {
      try {
        showSpinner();
        setTimeout(() => {
          table.download("pdf", "export.pdf", {
            orientation: "landscape",
            title: "Fire Compliance Data",
            jsPDF: { unit: "pt", format: "a4" },
            autoTable: { margin: { top: 50 }, styles: { fontSize: 6 } }
          });
          updateRowCount();
          hideSpinner();
        }, 100);
      } catch (e) {
        console.error("PDF Export Failed:", e);
        statusDiv.textContent = "❌ PDF Export Failed.";
        statusDiv.className = "text-red-500";
        hideSpinner();
      }
    });
    
    document.getElementById("refreshCountBtn")
            .addEventListener("click", updateRowCount);

    // Poll the due-count endpoint every 10 minutes
    async function refreshDueCount(){
      try {
        const resp = await fetch("/due-count");
        if (!resp.ok) throw new Error();
        const { count } = await resp.json();
        countSpan.textContent = count;
      } catch {
        console.error("Failed to fetch due-count");
        statusDiv.textContent = "❌ Failed to fetch task count.";
        statusDiv.className = "text-red-500";
      }
    }
    refreshDueCount();
    setInterval(refreshDueCount, 600000);

    // File upload handler
    window.uploadFile = function(){
      const inp  = document.getElementById("fileInput");
      const file = inp.files[0];
      if (!file) {
        statusDiv.textContent = "❌ Please select a file.";
        statusDiv.className   = "text-red-500";
        return;
      }
      const fd = new FormData();
      fd.append("file", file);
      showSpinner();
      fetch("/upload-csv/", { method: "POST", body: fd })
        .then(r => r.json())
        .then(data => {
          statusDiv.textContent = (data.status==="success"?"✅ ":"❌ ") + data.message;
          statusDiv.className   = data.status==="success"?"text-green-600":"text-red-500";
          if (data.status === "success") location.reload();
        })
        .catch(() => {
          statusDiv.textContent = "❌ Upload failed. Please try again.";
          statusDiv.className   = "text-red-500";
        })
        .finally(hideSpinner);
    };

    // Bootstrap sequence
    const data = await loadData();
    allColumns = getUniqueColumns(data);
    buildListButtons();
    initColumnSelect();
    initTabulator(data);

    // Restore last-used list filter (or default to “All”)
    const saved     = localStorage.getItem("selectedList") || "All";
    const btnToUse  = document.querySelector(`.filter-btn[data-list="${saved}"]`) ||
                     document.querySelector(`.filter-btn[data-list="All"]`);
    applyListFilter(btnToUse.dataset.list, btnToUse);
  });
  </script>
</body>
</html>

