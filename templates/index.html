<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fire Compliance Dashboard</title>

  <!-- TailwindCSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>

  <!-- Spinner & Active Button Styles -->
  <style>
    .filter-btn.active {
      background-color: #2563eb; /* bg-blue-600 */
      color: #ffffff;            /* text-white */
      border: 2px solid #1e40af; /* darker border for active */
    }
    .filter-btn {
      border: 2px solid transparent;
    }
    .filter-btn:focus {
      outline: none;
      border-color: #1e40af;
    }
    #loadingSpinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }
  </style>

  <!-- List definitions JSON -->
  <script>
    let listDefs = {}; // to be fetched from server
  </script>


  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css" rel="stylesheet"/>

  <!-- jsPDF + AutoTable for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>

<body class="bg-gray-100 text-gray-800">

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="flex items-center justify-center">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
  </div>

  <!-- Header -->
  <header class="bg-white shadow p-4 text-xl font-semibold flex justify-between items-center">
    <div>🔥 Fire Compliance Ltd. - Audit Dashboard [2025]</div>
    <a href="/pending_tasks"
       class="relative bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition text-sm">
      🕒 Tasks Due Soon
      <span id="dueCount"
            class="absolute -top-2 -right-2 bg-white text-red-600 font-bold rounded-full w-6 h-6 flex items-center justify-center text-xs shadow">
        0
      </span>
    </a>
  </header>

  <!-- Upload Section -->
  <section class="p-4 flex flex-col gap-4 items-center bg-white shadow mt-4 mx-4 rounded">
    <h2 class="text-lg font-semibold">📤 Upload CSV/Excel File</h2>
    <div class="flex gap-4 items-center">
      <a href="/csv-template" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 transition">
        📄 View CSV Format
      </a>
      <input id="fileInput" type="file" accept=".csv,.xlsx" class="border p-2 rounded w-72"/>
      <a href="/manual-entry" class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800 transition">
        📋 Manual Entry
      </a>
    </div>
    <button type="button" onclick="uploadFile()"
            class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
      🚀 Upload File
    </button>
    <div id="uploadStatus" class="text-sm mt-2"></div>
  </section>

  <!-- Filters & Table Controls -->
  <section class="mt-6 mx-4 bg-white p-4 rounded shadow">
    <!-- List Buttons -->
    <div id="listFilterButtons" role="tablist" class="flex flex-wrap gap-2 mb-4"></div>

    <!-- Column Select & Global Search -->
    <div class="flex flex-wrap justify-between mb-2">
      <label for="columnSelect" class="mr-2">🔽 Columns:</label>
      <select id="columnSelect" multiple class="border rounded px-2 py-1"></select>
      <input id="globalSearch" type="text" placeholder="🔍 Search..." class="border px-2 py-1 rounded"/>
    </div>
    <div class="flex gap-2 items-center mb-4">
      <button id="editListsBtn" class="bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700">
        ⚙️ Edit Lists
      </button>
    </div>

    <!-- Row Count -->
    <div class="mb-2 text-sm text-gray-600 flex items-center">
      <span id="rowCountDisplay">Total Rows: 0 | Filtered Rows: 0</span>
      <button id="refreshCountBtn"
              class="ml-4 px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">
        🔄 Refresh Count
      </button>
      <button id="bulkEditButton"
              class="ml-auto bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 transition">
        ✏️ Bulk Edit
      </button>
    </div>


    <!-- Data Table -->
    <div id="dynamicTable" class="w-full overflow-auto"></div>

    <!-- Export Buttons -->
    <div class="mt-4">
      <button id="exportCsvButton"
              class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition"
              aria-label="Export data to CSV">
        📥 Export CSV
      </button>
      <button id="exportPdfButton"
              class="ml-2 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition"
              aria-label="Export data to PDF">
        📄 Export PDF
      </button>
      <button id="saveFilterButton" class="ml-2 bg-yellow-400 text-white px-4 py-2 rounded hover:bg-yellow-500">💾 Save Filter</button>
      <button id="savedExportsButton" class="ml-2 bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">📚 Saved Exports</button>
 
     
    </div>
    <!-- Saved Exports Modal -->
    <div id="savedExportsModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
      <!-- backdrop -->
      <div id="savedExportsBackdrop" class="absolute inset-0 bg-black opacity-50"></div>

      <!-- modal panel -->
      <div class="relative max-w-4xl mx-auto mt-20 bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b">
          <h3 class="text-lg font-semibold">📚 Saved Exports</h3>
          <button id="savedExportsCloseBtn" class="text-gray-600 hover:text-gray-800 px-2 py-1 rounded" aria-label="Close saved exports">✕</button>
        </div>

        <div class="p-4 max-h-96 overflow-auto">
          <div id="savedExportsList" class="space-y-2">
            <div class="text-sm text-gray-500" id="savedExportsEmpty">Loading...</div>
          </div>
        </div>

        <div class="flex items-center justify-between gap-2 p-4 border-t bg-gray-50">
          <div class="flex items-center gap-2">
            <button id="downloadCombinedCsvBtn" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm">
              ⤓ Download Combined CSV
            </button>

            <button id="downloadCombinedPdfBtn" class="bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-700 text-sm">
              📄 Download Combined PDF
            </button>

            <button id="clearAllExportsBtn" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">
              🧹 Clear All
            </button>
          </div>

          <div>
            <button id="savedExportsDoneBtn" class="bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-800 text-sm">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

  </section>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    /* -----------------------
       DOM refs & global state
       ----------------------- */
    const spinner       = document.getElementById("loadingSpinner");
    const statusDiv     = document.getElementById("uploadStatus");
    const countSpan     = document.getElementById("dueCount");
    const listContainer = document.getElementById("listFilterButtons");
    const colSelect     = document.getElementById("columnSelect");
    const globalSearch  = document.getElementById("globalSearch");
    const exportCsvBtn  = document.getElementById("exportCsvButton");
    const exportPdfBtn  = document.getElementById("exportPdfButton");
    const saveFilterBtn = document.getElementById("saveFilterButton");
    const savedExportsBtn = document.getElementById("savedExportsButton");
    let allColumns = [];
    let table;

    // local listDefs (fetched from /api/lists)
    let listDefs = {};

    /* -----------------------
       Spinner helpers
       ----------------------- */
    const showSpinner = () => { if (spinner) spinner.style.display = "flex"; };
    const hideSpinner = () => { if (spinner) spinner.style.display = "none"; };

    /* -----------------------
       Data loading helpers
       ----------------------- */
    async function loadListDefinitions(){
      try {
        const res = await fetch("/api/lists");
        if (!res.ok) throw new Error("Failed to fetch list definitions");
        listDefs = await res.json();
      } catch (e) {
        console.error("Failed to load list definitions:", e);
        listDefs = { "All": allColumns };
      }
    }

    async function loadData(){
      showSpinner();
      try {
        const resp = await fetch("/api/data");
        if (!resp.ok) throw new Error("Failed to fetch data");
        return await resp.json();
      } catch (e) {
        console.error(e);
        statusDiv.textContent = "❌ Failed to load data.";
        statusDiv.className = "text-red-500";
        return [];
      } finally {
        hideSpinner();
      }
    }

    function getUniqueColumns(data){
      const keys = new Set();
      data.forEach(r => Object.keys(r).forEach(k => keys.add(k)));
      return Array.from(keys);
    }

    /* -----------------------
       Row counts & refresh
       ----------------------- */
    function updateRowCount(){
      try {
        const total    = table ? table.getDataCount("all") : 0;
        const filtered = table ? table.getDataCount("active") : 0;
        document.getElementById("rowCountDisplay")
                .textContent = `Total Rows: ${total} | Filtered Rows: ${filtered}`;
      } catch (e) {
        console.error("updateRowCount error", e);
      }
    }

    /* -----------------------
       Lists UI
       ----------------------- */
    function buildListButtons(){
      listContainer.innerHTML = "";
      listDefs["All"] = allColumns; // ensure “All” maps to every column
      Object.keys(listDefs).forEach(listName => {
        const btn = document.createElement("button");
        btn.type        = "button";
        btn.textContent = listName === "All" ? "All Columns" : listName;
        btn.className   = "filter-btn bg-gray-300 text-gray-800 px-3 py-1 rounded hover:bg-gray-400";
        btn.dataset.list = listName;
        btn.setAttribute("role", "tab");
        btn.setAttribute("aria-pressed", "false");
        btn.addEventListener("click", () => applyListFilter(listName, btn));
        listContainer.append(btn);
      });
    }

    document.getElementById("editListsBtn").addEventListener("click", () => {
      // simple edit flow (prompt-based)
      const listNames = Object.keys(listDefs).filter(l => l !== "All");
      const listName = prompt("Which list do you want to edit?\n" + listNames.join("\n") + "\n(Type NEW to add new list)");
      if (!listName) return;

      let currentCols = listDefs[listName] || [];

      const colInput = prompt(
        `Columns for ${listName}:\n(comma separated)\n\nAvailable columns:\n${allColumns.join(", ")}`,
        currentCols.join(", ")
      );
      if (colInput === null) return;

      const cleaned = colInput.split(",").map(c => c.trim()).filter(Boolean);

      if (cleaned.length === 0) {
        // user removed all columns → remove list
        if (confirm(`Remove list "${listName}"?`)) delete listDefs[listName];
      } else {
        listDefs[listName] = cleaned;
      }

      // Save updated definitions to backend
      fetch("/api/lists", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(listDefs)
      })
        .then(r => {
          if (!r.ok) throw new Error("Failed to save lists");
          return r.json();
        })
        .then(data => {
          alert("✅ List updated!");
          buildListButtons();
        })
        .catch(err => {
          console.error("Failed to save:", err);
          alert("❌ Failed to save lists.");
        });
    });

    /* -----------------------
       Column multi-select
       ----------------------- */
    function initColumnSelect(){
      colSelect.innerHTML = "";
      allColumns.forEach((col,i) => {
        const opt = document.createElement("option");
        opt.value       = col;
        opt.textContent = col;
        if (i < 6) opt.selected = true;
        colSelect.append(opt);
      });
      colSelect.addEventListener("change", () => {
        const chosen = Array.from(colSelect.selectedOptions).map(o => o.value);
        showHideColumns(chosen);
      });
    }

    function showHideColumns(colsToShow){
      if (!table) return;
      allColumns.forEach(col => {
        try {
          if (colsToShow.includes(col)) table.showColumn(col);
          else                          table.hideColumn(col);
        } catch (e) {
          // ignore missing column errors
        }
      });
      updateRowCount();
    }

    /* -----------------------
       Tabulator setup
       ----------------------- */
    function makeColumnsDef(){
      return [
        {
          title: "✏️ Edit", field: "edit",
          formatter: ()=>"<button class='bg-blue-500 text-white px-2 py-1 rounded text-sm'>Edit</button>",
          width: 90, hozAlign: "center",
          cellClick: (_e,cell)=> window.location.href = `/edit/${cell.getRow().getPosition()}`
        },
        ...allColumns.map(field => ({
          title: field,
          field: field,
          widthGrow: 1,
          widthShrink: 1,
          headerFilter: "input",
          headerFilterFunc: "=",
          headerFilterFuncParams: { ignoreCase: true },
          headerFilterLiveFilter: false,
          sorter: "string"
        }))
      ];
    }
    function distributeColumnsEvenly() {
      if (!table) return;
      const cols = table.getColumns();
      if (!cols || cols.length === 0) return;

      const tableWidth = document.getElementById("dynamicTable").offsetWidth;
      const width = Math.floor(tableWidth / cols.length);

      cols.forEach(col => {
        col.updateDefinition({ width: width }); // fixed px width
      });

      table.redraw(true);
    }

    function initTabulator(data){
      table = new Tabulator("#dynamicTable", {
        data: data,
        layout: "fitDataStretch",
        pagination: "local",
        paginationSize: 30,
        columns: makeColumnsDef(),
        dataFiltered: updateRowCount,
        dataSorted:   updateRowCount
      });
      updateRowCount();

      // 👇 Force equal column widths
      distributeColumnsEvenly();
    }

    function applyListFilter(listName, btn){
      document.querySelectorAll(".filter-btn").forEach(b => {
        b.classList.remove("active");
        b.setAttribute("aria-pressed", "false");
      });
      btn.classList.add("active");
      btn.setAttribute("aria-pressed", "true");

      const cols = listDefs[listName] || [];
      showHideColumns(listName === "All" ? allColumns : cols);
      // sync the multi-select
      document.querySelectorAll("#columnSelect option").forEach(opt => {
        opt.selected = (listName === "All") ? true : cols.includes(opt.value);
      });
      localStorage.setItem("selectedList", listName);
    }

    /* -----------------------
       Search
       ----------------------- */
    globalSearch.addEventListener("input", e => {
      const term = e.target.value.toLowerCase();
      if (!table) return;
      table.setFilter(row => 
        Object.values(row).some(v => String(v).toLowerCase().includes(term))
      );
      updateRowCount();
    });
    
    
    /* -----------------------
       Export buttons (table-level)
       ----------------------- */
    exportCsvBtn.addEventListener("click", () => {
      try {
        showSpinner();
        setTimeout(() => {
          table.download("csv", "export.csv");
          updateRowCount();
          hideSpinner();
        }, 100);
      } catch (e) {
        console.error("CSV Export Failed:", e);
        statusDiv.textContent = "❌ CSV Export Failed.";
        statusDiv.className = "text-red-500";
        hideSpinner();
      }
    });

    exportPdfBtn.addEventListener("click", () => {
      try {
        showSpinner();
        setTimeout(() => {
          table.download("pdf", "export.pdf", {
            orientation: "landscape",
            title: "Fire Compliance Data",
            jsPDF: { unit: "pt", format: "a4" },
            autoTable: { margin: { top: 50 }, styles: { fontSize: 6 } }
          });
          updateRowCount();
          hideSpinner();
        }, 100);
      } catch (e) {
        console.error("PDF Export Failed:", e);
        statusDiv.textContent = "❌ PDF Export Failed.";
        statusDiv.className = "text-red-500";
        hideSpinner();
      }
    });

    /* -----------------------
       Bulk Edit
       ----------------------- */
    document.getElementById("bulkEditButton").addEventListener("click", async () => {
      if (!allColumns || allColumns.length === 0) { alert("No columns available."); return; }
      const column = prompt("Column to edit:\n" + allColumns.join("\n"));
      if (!column || !allColumns.includes(column)) {
        return alert("Invalid column name.");
      }
      const newValue = prompt(`Enter the new value for "${column}":`);
      if (newValue === null) return; // user cancelled

      const rows = table.getRows("active");
      rows.forEach(row => row.update({ [column]: newValue }));
      updateRowCount();

      const updates = rows.map(row => ({
        rowIndex: row.getPosition(),
        column,
        value: newValue
      }));

      try {
        const resp = await fetch("/api/bulk-update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ updates })
        });
        const result = await resp.json();
        if (result.status !== "success") throw new Error(result.message || "bulk update failed");
        alert("✅ Bulk edit saved!");
      } catch (err) {
        console.error("Bulk edit failed:", err);
        alert("❌ Bulk edit failed: " + (err.message || err));
      } 
    });

    /* -----------------------
       Save filtered rows (Saved Exports)
       ----------------------- */
    saveFilterBtn.addEventListener("click", async () => {
      try {
        const rows = table.getData("active"); // currently filtered rows
        if (!rows || rows.length === 0) return alert("No rows to save.");
        const name = prompt(`Name for saved set (optional). ${rows.length} rows will be saved:`, `Saved set ${new Date().toLocaleString()}`);
        if (name === null) return; // cancelled
        showSpinner();
        const resp = await fetch("/api/save-filtered", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, rows })
        });
        const result = await resp.json();
        hideSpinner();
        if (result.status === "success") {
          alert("✅ Saved filter set!");
        } else {
          alert("❌ Failed to save: " + (result.message || JSON.stringify(result)));
        }
      } catch (e) {
        hideSpinner();
        console.error(e);
        alert("❌ Error saving filter.");
      }
    });

    /* -----------------------
       Saved Exports Modal + PDF helpers
       ----------------------- */
    (function () {
      const modal     = document.getElementById("savedExportsModal");
      const backdrop  = document.getElementById("savedExportsBackdrop");
      const listEl    = document.getElementById("savedExportsList");
      const closeBtn  = document.getElementById("savedExportsCloseBtn");
      const doneBtn   = document.getElementById("savedExportsDoneBtn");
      const dlCsvBtn  = document.getElementById("downloadCombinedCsvBtn");
      const dlPdfBtn  = document.getElementById("downloadCombinedPdfBtn");
      const clearAllBtn = document.getElementById("clearAllExportsBtn");

      function _showSpinner(){ if (typeof showSpinner === "function") showSpinner(); else document.body.style.cursor = "wait"; }
      function _hideSpinner(){ if (typeof hideSpinner === "function") hideSpinner(); else document.body.style.cursor = "default"; }

      function openModal(){
        modal.classList.remove("hidden");
        modal.setAttribute("aria-hidden", "false");
        loadSavedExports();
      }
      function closeModal(){
        modal.classList.add("hidden");
        modal.setAttribute("aria-hidden", "true");
        listEl.innerHTML = '<div class="text-sm text-gray-500" id="savedExportsEmpty">Loading...</div>';
      }

      function fmtTs(ts){
        try { return new Date(ts * 1000).toLocaleString(); } catch { return ""; }
      }

      async function loadSavedExports(){
        _showSpinner();
        try {
          const resp = await fetch("/api/saved-exports");
          if (!resp.ok) throw new Error("Failed to fetch saved exports");
          const items = await resp.json();
          renderList(items || []);
        } catch (e) {
          console.error("Failed to load saved exports", e);
          listEl.innerHTML = '<div class="text-sm text-red-500">Failed to load saved exports.</div>';
        } finally {
          _hideSpinner();
        }
      }

      function renderList(items){
        listEl.innerHTML = "";
        if (!items || items.length === 0){
          listEl.innerHTML = '<div class="text-sm text-gray-600">No saved exports found.</div>';
          return;
        }

        items.forEach(it => {
          const row = document.createElement("div");
          row.className = "flex items-center justify-between gap-4 bg-white p-3 rounded border";

          const left = document.createElement("div");
          left.className = "min-w-0";
          const title = document.createElement("div");
          title.className = "font-medium truncate";
          title.textContent = it.name || (`Saved ${it.id}`);
          const meta = document.createElement("div");
          meta.className = "text-xs text-gray-500";
          meta.textContent = `${it.count} rows — ${fmtTs(it.created_at)}`;
          left.appendChild(title);
          left.appendChild(meta);

          const right = document.createElement("div");
          right.className = "flex items-center gap-2";

          // CSV download
          const dlBtn = document.createElement("button");
          dlBtn.className = "bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 text-sm";
          dlBtn.textContent = "⤓ CSV";
          dlBtn.onclick = () => { window.location.href = `/api/saved-exports/${it.id}/download`; };

          // PDF download (client-side for single exports)
          const pdfBtn = document.createElement("button");
          pdfBtn.className = "bg-purple-600 text-white px-2 py-1 rounded hover:bg-purple-700 text-sm";
          pdfBtn.textContent = "📄 PDF";
          pdfBtn.onclick = async () => {
            _showSpinner();
            try {
              const r = await fetch(`/api/saved-exports/${it.id}`);
              if (!r.ok) throw new Error("Failed to fetch saved export");
              const payload = await r.json();
              if (!payload || !payload.rows || !Array.isArray(payload.rows) || payload.rows.length === 0) { alert("No rows"); return; }
              await generateAndDownloadPDF(payload.rows, (payload.name || "saved_export"));
            } catch (e) {
              console.error(e);
              alert("Failed to generate PDF for this set.");
            } finally {
              _hideSpinner();
            }
          };

          // Delete button
          const delBtn = document.createElement("button");
          delBtn.className = "bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 text-sm";
          delBtn.textContent = "🗑️ Delete";
          delBtn.onclick = async () => {
            if (!confirm(`Delete "${it.name}"? This cannot be undone.`)) return;
            _showSpinner();
            try {
              await fetch(`/api/saved-exports/${it.id}`, { method: "DELETE" });
              await loadSavedExports();
            } catch (e) {
              console.error(e);
              alert("Failed to delete saved export.");
            } finally {
              _hideSpinner();
            }
          };

          // id copy button
          const idSpan = document.createElement("button");
          idSpan.className = "text-xs text-gray-400 hover:text-gray-700 px-2";
          idSpan.textContent = "🔗";
          idSpan.title = `Copy id ${it.id}`;
          idSpan.onclick = () => {
            navigator.clipboard?.writeText(it.id).then(()=>{ idSpan.textContent = "✅"; setTimeout(()=>idSpan.textContent="🔗",800); }).catch(()=>{ alert("Copy failed"); });
          };

          right.appendChild(dlBtn);
          right.appendChild(pdfBtn);
          right.appendChild(delBtn);
          right.appendChild(idSpan);

          row.appendChild(left);
          row.appendChild(right);

          listEl.appendChild(row);
        });
      }

      // PDF utility for single exports
      function buildColumnsFromRows(rows) {
        const colSet = new Set();
        rows.forEach(r => Object.keys(r).forEach(k => colSet.add(k)));
        const preferred = ["id","Region","Address","Equipment_No","Unit No","Plan Finish Date","Scheduled Date"];
        const cols = Array.from(colSet);
        cols.sort((a,b) => {
          const ai = preferred.indexOf(a) >= 0 ? preferred.indexOf(a) - 100 : 0;
          const bi = preferred.indexOf(b) >= 0 ? preferred.indexOf(b) - 100 : 0;
          if (ai !== bi) return ai - bi;
          return a.localeCompare(b);
        });
        return cols;
      }

      function rowsToTableArrays(rows, columns) {
        return rows.map(r => columns.map(c => {
          const v = r[c];
          if (v === null || v === undefined) return "";
          if (typeof v === "object") return JSON.stringify(v);
          return String(v);
        }));
      }

      async function generateAndDownloadPDF(rows, filenamePrefix="saved_export") {
        if (!Array.isArray(rows) || rows.length === 0) { alert("No rows to export."); return; }
        const columns = buildColumnsFromRows(rows);
        const body = rowsToTableArrays(rows, columns);
        try {
          _showSpinner();
          const { jsPDF } = window.jspdf || window;
          const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
          const title = `${filenamePrefix}_${new Date().toISOString().replace(/[:.]/g,"-")}`;
          doc.setFontSize(12);
          doc.text(title, 40, 40);
          doc.autoTable({
            startY: 60,
            head: [columns],
            body: body,
            styles: { fontSize: 8, cellPadding: 4 },
            headStyles: { fillColor: [60, 60, 60] },
            margin: { left: 20, right: 20 },
            didDrawPage: (data) => {
              const page = doc.internal.getNumberOfPages();
              doc.setFontSize(9);
              doc.text(`Page ${page}`, doc.internal.pageSize.getWidth() - 60, doc.internal.pageSize.getHeight() - 10);
            }
          });
          doc.save(`${title}.pdf`);
        } catch (e) {
          console.error("PDF generation failed", e);
          alert("PDF generation failed: " + (e && e.message ? e.message : e));
        } finally {
          _hideSpinner();
        }
      }

      // Combined PDF download (server-side)
      dlPdfBtn.addEventListener("click", () => {
        window.location.href = "/api/saved-exports/combined/pdf";
      });

      // Combined CSV download
      dlCsvBtn.addEventListener("click", () => {
        window.location.href = "/api/saved-exports/combined/download";
      });

      // Clear all saved exports
      clearAllBtn.addEventListener("click", async () => {
        if (!confirm("Clear ALL saved exports? This cannot be undone.")) return;
        _showSpinner();
        try {
          await fetch("/api/saved-exports/clear", { method: "POST" });
          await loadSavedExports();
        } catch (e) {
          console.error("Failed to clear saved exports", e);
          alert("Failed to clear saved exports.");
        } finally {
          _hideSpinner();
        }
      });

      // Close handlers
      closeBtn.addEventListener("click", closeModal);
      doneBtn.addEventListener("click", closeModal);
      backdrop.addEventListener("click", closeModal);

      // Toolbar wiring
      if (savedExportsBtn) savedExportsBtn.addEventListener("click", openModal);
      else window.openSavedExportsModal = openModal;

      // Expose generate function for single exports
      window.generateAndDownloadPDF = generateAndDownloadPDF;
    })();

    /* -----------------------
       File upload handler
       ----------------------- */
    window.uploadFile = function(){
      const inp  = document.getElementById("fileInput");
      const file = inp && inp.files && inp.files[0];
      if (!file) {
        statusDiv.textContent = "❌ Please select a file.";
        statusDiv.className   = "text-red-500";
        return;
      }
      const fd = new FormData();
      fd.append("file", file);
      showSpinner();
      fetch("/upload-csv/", { method: "POST", body: fd })
        .then(r => r.json())
        .then(data => {
          statusDiv.textContent = (data.status==="success"?"✅ ":"❌ ") + data.message;
          statusDiv.className   = data.status==="success"?"text-green-600":"text-red-500";
          if (data.status === "success") location.reload();
        })
        .catch(() => {
          statusDiv.textContent = "❌ Upload failed. Please try again.";
          statusDiv.className = "text-red-500";
        })
        .finally(hideSpinner);
    };

    /* -----------------------
       Due-count polling
       ----------------------- */
    // ---------- refresh / due-count helper (single source of truth) ----------
    let _dueCountInFlight = null; // holds AbortController for in-flight request (optional)

    async function refreshDueCount() {
      // cancel a previous in-flight request
      try { if (_dueCountInFlight) _dueCountInFlight.abort(); } catch(e){}

      // create new abort controller for this call (optional)
      const ac = new AbortController();
      _dueCountInFlight = ac;

      // show spinner if available
      if (typeof showSpinner === "function") showSpinner();

      try {
        const resp = await fetch("/due-count", { signal: ac.signal });
        if (!resp.ok) {
          // if backend returns 4xx/5xx, treat as no-data but surface error
          console.error("due-count response not OK:", resp.status);
          document.getElementById("dueCount").textContent = "0";
          return;
        }
        const payload = await resp.json();
        // prefer numeric display; fallback to 0
        const count = (payload && typeof payload.count === "number") ? payload.count : (parseInt(payload?.count) || 0);
        document.getElementById("dueCount").textContent = String(count);
      } catch (err) {
        if (err.name === "AbortError") {
          // aborted intentionally — ignore
          return;
        }
        console.error("Failed to fetch due-count:", err);
        // set visible fallback and a short console-friendly message
        document.getElementById("dueCount").textContent = "0";
        // optionally show a small error in uploadStatus area (non-blocking)
        try { statusDiv.textContent = "❌ Failed to fetch task count."; statusDiv.className = "text-red-500"; } catch(e){}
      } finally {
        _dueCountInFlight = null;
        if (typeof hideSpinner === "function") hideSpinner();
      }
    }

    // Hook the button and the interval (call once immediately)
    // Replace the old binding that called refreshDueCount
    const refreshBtn = document.getElementById("refreshCountBtn");
    if (refreshBtn) {
      // remove any existing listeners by replacing the node (safe)
      const newBtn = refreshBtn.cloneNode(true);
      refreshBtn.parentNode.replaceChild(newBtn, refreshBtn);

      // When clicked, update the table counts (no network)
      newBtn.addEventListener("click", () => {
        updateRowCount(); // updates the "rowCountDisplay"

        // brief visual feedback: flash the rowCountDisplay
        const display = document.getElementById("rowCountDisplay");
        if (display) {
          display.style.transition = "background-color 0.3s";
          display.style.backgroundColor = "#eefaf0"; // pale green flash
          setTimeout(() => { display.style.backgroundColor = ""; }, 500);
        }
      });
    }


    


    /* -----------------------
       Bootstrap sequence
       ----------------------- */
    const data = await loadData();
    allColumns = getUniqueColumns(data);
    await loadListDefinitions();
    buildListButtons();
    initColumnSelect();
    initTabulator(data);

    window.addEventListener("resize", () => { if (table) table.redraw(true); });

    // Restore last-used list filter (or default to “All”)
    try {
      const saved     = localStorage.getItem("selectedList") || "All";
      const btnToUse  = document.querySelector(`.filter-btn[data-list="${saved}"]`) ||
                       document.querySelector(`.filter-btn[data-list="All"]`);
      if (btnToUse) applyListFilter(btnToUse.dataset.list, btnToUse);
    } catch (e) {
      // ignore if no list button yet
    }

    // Safe initial count refresh
    updateRowCount();
  }); // end DOMContentLoaded
  </script>

</body>
</html>

